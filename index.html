<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Srila Prabhupada Quotes</title>
    <link rel="icon" href="favicon.ico?v=1" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent: #ffd54f;
            --accent-hover: #ffea97;
            --header-height: 60px;
            --search-height: 50px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .header {
            background-color: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        h1 {
            text-align: center;
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.8rem;
            letter-spacing: 0.5px;
        }

        .search-container {
            position: sticky;
            top: var(--header-height);
            z-index: 90;
            background: var(--bg-color);
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(255, 213, 79, 0.2);
        }

        input[type="text"]::placeholder {
            color: #aaa;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .quote-card {
            background: var(--card-bg);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            padding: 1.5rem 1.8rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .quote-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }

        .statement {
            font-size: 1.15rem;
            margin-bottom: 0.8rem;
            line-height: 1.6;
        }

        .ref {
            font-size: 0.95rem;
            color: #bbb;
            font-style: italic;
        }

        #loading {
            text-align: center;
            margin: 2rem;
            font-size: 1.2rem;
            color: var(--accent);
            display: none;
        }

        .content {
            padding: 2rem 0;
            min-height: calc(100vh - var(--header-height) - var(--search-height));
        }

        .btn {
            background: linear-gradient(to right, var(--accent), #ffb300);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(255, 213, 79, 0.3);
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: linear-gradient(to right, var(--accent-hover), #ffc107);
            box-shadow: 0 6px 12px rgba(255, 213, 79, 0.4);
            transform: translateY(-2px);
        }

        .btn i {
            font-size: 0.9rem;
        }

        .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            color: var(--accent);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            backdrop-filter: blur(5px);
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        .quote-card:hover .copy-btn {
            opacity: 1;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .filter-chip {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(255, 213, 79, 0.2);
        }

        .filter-chip.active {
            background: var(--accent);
            color: #000;
            font-weight: 500;
        }

        .no-results {
            text-align: center;
            margin: 3rem 0;
            color: #888;
            font-size: 1.1rem;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        .refresh-btn {
            background: linear-gradient(to right, #2c2c2c, #3c3c3c);
            color: var(--accent);
            border: 1px solid rgba(255, 213, 79, 0.3);
        }

        .refresh-btn:hover {
            background: linear-gradient(to right, #2a2a2a, #3a3a3a);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .quote-card {
                padding: 1.2rem 1.5rem;
            }

            .statement {
                font-size: 1.05rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="container">
            <h1>Hare Krishna Mohana Prabhuji 😊, PAMHO 🙇</h1>
        </div>
    </div>

    <div class="search-container">
        <div class="container">
            <div class="search-wrapper">
                <input type="text" id="search" placeholder="Search by reference (BG, SB), keyword, or meaning..." />
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="filters" id="filters">
                <!-- Filters will be generated dynamically -->
            </div>

            <div class="actions">
                <button id="refreshBtn" class="btn refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh Quotes
                </button>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="container">
            <div id="loading">Finding quotes...</div>
            <div id="results"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const state = {
            quotes: [],
            flatQuotes: [],
            filters: {
                topics: new Set(),
                activeFilters: new Set()
            }
        };

        const elements = {
            searchInput: document.getElementById('search'),
            loading: document.getElementById('loading'),
            results: document.getElementById('results'),
            filtersContainer: document.getElementById('filters'),
            toast: document.getElementById('toast'),
            refreshBtn: document.getElementById('refreshBtn')
        };

        // Sample data for testing - would be replaced by your actual quotes.json
        const sampleQuotes = [
            {
                "ref": "Bhagavad-gītā 4.11",
                "speaker": "Lord Kṛṣṇa",
                "scripture": "BG",
                "chapter": "4",
                "verse": "11",
                "statements": [
                    {
                        "statement": "As all surrender unto Me, I reward them accordingly. Everyone follows My path in all respects, O son of Pṛthā.",
                        "tags": ["surrender", "reciprocation", "devotional service"],
                        "keywords": ["surrender", "reward", "path"]
                    }
                ]
            },
            {
                "ref": "Śrīla Prabhupāda lecture on Bg 2.48 in New York in 1966",
                "speaker": "Śrīla Prabhupāda",
                "date": "1966",
                "location": "New York",
                "lecture": "Lecture on Bg 2.48",
                "statements": [
                    {
                        "statement": "You should not be anxious for the success or failure of the attempt you are making. Suppose you are working in a firm selling something. You go out and sincerely work. Suppose one day you get business worth 100,000 dollars, and another day you don't get any business. It doesn't matter, because your connection with the master is there and so you get your salary. When the profit is 100,000 dollars, you don't expect any profit, and when there is no business, there is no loss on your part. Siddhy-asiddhyoh.",
                        "tags": ["karma", "duty", "detachment"],
                        "keywords": ["success", "failure", "result", "salary", "master"]
                    },
                    {
                        "statement": "I am going to my office to earn some money, because without money, my household affairs could not go on. I am thinking, 'This money is required, otherwise God's service will be stopped.' So while earning money in my office, my God consciousness is there. Therefore, even while earning, whatever the process may be, you are yoga-sthah, situated in yoga. You get some money and go to the market. You are thinking, 'Oh, this is a very nice thing. It can be offered to Lord Kṛṣṇa.' Just like sometimes you bring some fruit for me, thinking, out of your love, 'Swamiji will eat this and he will like it.' Out of love, you think of Swamiji, and Swamiji is thought of because he is in relation with God. So this is God consciousness. It is just like electricity. Anything connected with the powerhouse is surcharged with electricity.",
                        "tags": ["yoga", "work", "God consciousness", "money"],
                        "keywords": ["office", "earning", "Krishna", "Swamiji", "electricity"]
                    }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // For testing, we'll use the sample data instead of loading from a file
            // Remove this when deploying with your actual quotes.json
            simulateQuotesLoad();

            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));

            elements.refreshBtn.addEventListener('click', () => {
                refreshQuotes();
            });
        });

        // For testing purposes only
        function simulateQuotesLoad() {
            elements.loading.style.display = 'block';
            setTimeout(() => {
                state.quotes = sampleQuotes;
                processQuotes();
                elements.loading.style.display = 'none';
            }, 500);
        }

        function refreshQuotes() {
            loadQuotes();
            showToast("Quotes refreshed successfully");
        }

        async function loadQuotes() {
            try {
                elements.loading.style.display = 'block';
                const response = await fetch("quotes.json?v=" + new Date().getTime());
                state.quotes = await response.json();
                processQuotes();
                elements.loading.style.display = 'none';
            } catch (error) {
                console.error("Error loading quotes:", error);
                elements.loading.style.display = 'none';
                elements.results.innerHTML = `<div class="error">Error loading quotes: ${error.message}</div>`;
            }
        }

        function processQuotes() {
            state.flatQuotes = [];
            const topicSet = new Set();

            state.quotes.forEach(entry => {
                // Extract scripture, chapter, verse information for easier searching
                const scriptureInfo = extractScriptureInfo(entry.ref);

                entry.statements.forEach((item, index) => {
                    if (!item.id) {
                        item.id = entry.ref.replace(/\s+/g, '') + "-" + index;
                    }

                    const topics = [];
                    if (item.tags && Array.isArray(item.tags)) {
                        item.tags.forEach(tag => {
                            topics.push(tag);
                            topicSet.add(tag);
                        });
                    }
                    if (item.keywords && Array.isArray(item.keywords)) {
                        item.keywords.forEach(keyword => {
                            topics.push(keyword);
                            topicSet.add(keyword);
                        });
                    }

                    state.flatQuotes.push({
                        ...item,
                        ref: entry.ref,
                        topics: topics,
                        scriptureCode: scriptureInfo.scriptureCode,
                        chapter: scriptureInfo.chapter,
                        verse: scriptureInfo.verse,
                        speaker: entry.speaker || "",
                        lecture: entry.lecture || ""
                    });
                });
            });

            state.filters.topics = Array.from(topicSet).sort();
            renderFilters();
            renderResults(state.flatQuotes);
        }

        function extractScriptureInfo(ref) {
            const info = {
                scriptureCode: "",
                chapter: "",
                verse: ""
            };

            // Common scripture abbreviations
            const scripturePatterns = [
                { pattern: /\bBG\b|Bhagavad-gītā|Bhagavad-gita/i, code: "BG" },
                { pattern: /\bSB\b|Śrīmad-Bhāgavatam|Srimad-Bhagavatam/i, code: "SB" },
                { pattern: /\bCC\b|Caitanya-caritāmṛta|Caitanya-caritamrta/i, code: "CC" },
                { pattern: /\bNOD\b|Nectar of Devotion/i, code: "NOD" },
                { pattern: /\bISO\b|Īśopaniṣad|Isopanisad/i, code: "ISO" }
            ];

            // Check for scripture code
            for (const pattern of scripturePatterns) {
                if (pattern.pattern.test(ref)) {
                    info.scriptureCode = pattern.code;
                    break;
                }
            }

            // Extract chapter and verse numbers if they exist
            const chapterVersePattern = /(\d+)\.(\d+)/;
            const chapterVerseMatch = ref.match(chapterVersePattern);

            if (chapterVerseMatch) {
                info.chapter = chapterVerseMatch[1];
                info.verse = chapterVerseMatch[2];
            } else {
                // Try to find just a chapter number
                const chapterPattern = /chapter (\d+)|lecture on .* (\d+)/i;
                const chapterMatch = ref.match(chapterPattern);

                if (chapterMatch) {
                    info.chapter = chapterMatch[1] || chapterMatch[2];
                }
            }

            return info;
        }

        function renderFilters() {
            const topTopics = state.filters.topics.slice(0, 15);
            elements.filtersContainer.innerHTML = '';

            topTopics.forEach(topic => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.textContent = topic;
                chip.dataset.topic = topic;

                if (state.filters.activeFilters.has(topic)) {
                    chip.classList.add('active');
                }

                chip.addEventListener('click', () => {
                    if (state.filters.activeFilters.has(topic)) {
                        state.filters.activeFilters.delete(topic);
                        chip.classList.remove('active');
                    } else {
                        state.filters.activeFilters.add(topic);
                        chip.classList.add('active');
                    }

                    handleSearch();
                });

                elements.filtersContainer.appendChild(chip);
            });
        }

        function handleSearch() {
            const searchTerm = elements.searchInput.value.trim();

            if (!searchTerm) {
                if (state.filters.activeFilters.size > 0) {
                    const filteredResults = state.flatQuotes.filter(quote =>
                        quote.topics && quote.topics.some(topic =>
                            state.filters.activeFilters.has(topic)
                        )
                    );
                    renderResults(filteredResults);
                } else {
                    renderResults(state.flatQuotes);
                }
                return;
            }

            const results = enhancedSearch(searchTerm);
            renderResults(results);
        }

        function enhancedSearch(query) {
            query = query.toLowerCase();
            let keywords = [];
            let phrases = [];
            const phraseRegex = /"([^"]*)"/g;
            let match;

            while ((match = phraseRegex.exec(query)) !== null) {
                phrases.push(match[1].toLowerCase());
            }

            const remainingQuery = query.replace(/"([^"]*)"/g, '').trim();
            keywords = remainingQuery.split(/\s+/).filter(k => k.length > 0); // Allow shorter keywords

            let quotesToSearch = state.flatQuotes;
            if (state.filters.activeFilters.size > 0) {
                quotesToSearch = state.flatQuotes.filter(quote =>
                    quote.topics && quote.topics.some(topic =>
                        state.filters.activeFilters.has(topic)
                    )
                );
            }

            // Check for scripture reference pattern like "BG 4.11"
            const scriptureReferencePattern = /^(bg|sb|cc|iso)\s*(\d+)(?:\.(\d+))?$/i;
            const scriptureRefMatch = query.match(scriptureReferencePattern);

            if (scriptureRefMatch) {
                const scriptureCode = scriptureRefMatch[1].toUpperCase();
                const chapter = scriptureRefMatch[2];
                const verse = scriptureRefMatch[3] || "";

                return quotesToSearch.filter(quote => {
                    if (quote.scriptureCode === scriptureCode) {
                        if (verse) {
                            return quote.chapter === chapter && quote.verse === verse;
                        } else {
                            return quote.chapter === chapter;
                        }
                    }
                    return false;
                });
            }

            return quotesToSearch
                .map(quote => {
                    const statement = quote.statement.toLowerCase();
                    const refText = quote.ref.toLowerCase();
                    let score = 0;

                    // Check reference directly
                    if (refText.includes(query)) {
                        score += 15;
                    }

                    // Check for scripture code match (e.g., "BG", "SB")
                    if (quote.scriptureCode && query.toUpperCase() === quote.scriptureCode) {
                        score += 15;
                    }

                    // Score phrases in statement
                    phrases.forEach(phrase => {
                        if (statement.includes(phrase)) {
                            score += 10;
                        }
                    });

                    // Score keywords in statement
                    keywords.forEach(keyword => {
                        const wordRegex = new RegExp(`\\b${keyword}\\b`, 'i');
                        if (wordRegex.test(statement)) {
                            score += 3;
                        }
                        else if (statement.includes(keyword)) {
                            score += 1;
                        }

                        // Check keywords in reference
                        if (refText.includes(keyword)) {
                            score += 4;
                        }

                        // Check keywords in speaker
                        if (quote.speaker && quote.speaker.toLowerCase().includes(keyword)) {
                            score += 3;
                        }

                        // Check keywords in lecture
                        if (quote.lecture && quote.lecture.toLowerCase().includes(keyword)) {
                            score += 3;
                        }
                    });

                    if (statement.includes(remainingQuery)) {
                        score += 5;
                    }

                    if (quote.tags) {
                        [...keywords, ...phrases].forEach(term => {
                            if (quote.tags.some(tag => tag.toLowerCase().includes(term))) {
                                score += 2;
                            }
                        });
                    }

                    if (quote.keywords) {
                        [...keywords, ...phrases].forEach(term => {
                            if (quote.keywords.some(k => k.toLowerCase().includes(term))) {
                                score += 2;
                            }
                        });
                    }

                    return {
                        ...quote,
                        score: score
                    };
                })
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score);
        }

        function renderResults(data) {
            elements.results.innerHTML = "";

            if (data.length === 0) {
                elements.results.innerHTML = "<div class='no-results'>No matching quotes found</div>";
                return;
            }

            data.forEach(item => {
                const card = document.createElement("div");
                card.className = "quote-card";

                const statementText = item.statement;
                const refText = item.ref;

                card.innerHTML = `
                    <div class="statement">"${statementText}"</div>
                    <div class="ref">— ${refText}</div>
                    <button class="copy-btn" title="Copy quote"><i class="fas fa-copy"></i></button>
                `;

                card.querySelector('.copy-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(`"${statementText}" — ${refText}`);
                });

                elements.results.appendChild(card);
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => showToast("Quote copied to clipboard"))
                .catch(() => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        document.execCommand('copy');
                        showToast("Quote copied to clipboard");
                    } catch (err) {
                        showToast("Failed to copy. Please copy manually.");
                    }

                    document.body.removeChild(textArea);
                });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = 1;

            setTimeout(() => {
                toast.style.opacity = 0;
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>

</html>